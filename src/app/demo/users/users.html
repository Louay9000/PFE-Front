<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="text-primary">ğŸ‘¤ Users</h1>

    <button *ngIf="Auth.isAdmin()" class="btn btn-success" (click)="openAddUserPopup()">
      <i class="bi bi-person-plus"></i>
    </button>
  </div>


  <div class="container mt-4">
  <div class="row">
    <div
      class="col-md-6 col-lg-4 mb-4"
      *ngFor="let user of UsersList | paginate: {id: 'users-pagination', itemsPerPage: 3, currentPage: p }"
    >
      <div class="profile-card">
        <!-- Photo de profil (image ou initiales) -->
        <div class="profile-image">
          <ng-container *ngIf="getUserImage(user)?.imageUrl; else initials">
            <img
              [src]="getUserImage(user)?.imageUrl"
              alt="User Image"
              class="user-avatar"
            />
          </ng-container>
          <ng-template #initials>
            <svg
              class="user-avatar"
              viewBox="0 0 100 100"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle cx="50" cy="50" r="48" fill="#7fcef2" />
              <text
                x="50%"
                y="55%"
                text-anchor="middle"
                font-size="32"
                fill="white"
                font-family="Arial, sans-serif"
                dominant-baseline="middle"
              >
                {{ user.firstname[0] }}{{ user.lastname[0] }}
              </text>
            </svg>
          </ng-template>
        </div>

        <!-- Informations utilisateur -->
        <div class="profile-info">
          <p class="profile-name">{{ user.firstname }} {{ user.lastname }}</p>
          <div class="profile-email">{{ user.email }}</div>
          <div class="profile-bio">
            <div><strong>Role:</strong> {{ user.role }}</div>
            <div>
              <strong>Department:</strong>
              {{ user.department?.departmentName || 'N/A' }}
            </div>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="social-links">
          <button
          *ngIf="Auth.isAdmin()"
            class="social-btn"
            title="Edit"
            (click)="openUpdateUseropup(user)"
          >
            <i class="bi bi-pencil-fill"></i>
          </button>
          <button
          *ngIf="Auth.isAdmin()"
            class="social-btn"
            title="Delete"
            (click)="deleteUser(user)">
            <i class="bi bi-trash-fill"></i>
          </button>
          <button *ngIf="Auth.isManager()"
            class="social-btn"
            title="View"
            (click)="getTasksByUserId(user)">
            <i class="bi bi-eye-fill"></i>
          </button>
          <!-- Chat Button -->
          <button (click)="openMessagesWithUser(user)" class="chatBtn">
          <svg height="1.6em" fill="white" xml:space="preserve" viewBox="0 0 1000 1000" y="0px" x="0px" version="1.1">
          <path d="M881.1,720.5H434.7L173.3,941V720.5h-54.4C58.8,720.5,10,671.1,10,610.2v-441C10,108.4,58.8,59,118.9,59h762.2C941.2,59,990,108.4,990,169.3v441C990,671.1,941.2,720.5,881.1,720.5L881.1,720.5z M935.6,169.3c0-30.4-24.4-55.2-54.5-55.2H118.9c-30.1,0-54.5,24.7-54.5,55.2v441c0,30.4,24.4,55.1,54.5,55.1h54.4h54.4v110.3l163.3-110.2H500h381.1c30.1,0,54.5-24.7,54.5-55.1V169.3L935.6,169.3z M717.8,444.8c-30.1,0-54.4-24.7-54.4-55.1c0-30.4,24.3-55.2,54.4-55.2c30.1,0,54.5,24.7,54.5,55.2C772.2,420.2,747.8,444.8,717.8,444.8L717.8,444.8z M500,444.8c-30.1,0-54.4-24.7-54.4-55.1c0-30.4,24.3-55.2,54.4-55.2c30.1,0,54.4,24.7,54.4,55.2C554.4,420.2,530.1,444.8,500,444.8L500,444.8z M282.2,444.8c-30.1,0-54.5-24.7-54.5-55.1c0-30.4,24.4-55.2,54.5-55.2c30.1,0,54.4,24.7,54.4,55.2C336.7,420.2,312.3,444.8,282.2,444.8L282.2,444.8z"></path>
          </svg>
          <span class="tooltip">Chat</span>
          </button>
        </div>
      </div>
  </div>

  <!-- Conversation Form -->
  <div *ngIf="chatForm" class="chat-window">
  <div *ngFor="let msg of messages"
  [ngClass]="{'my-message': msg.sender.id === Auth.userId, 'other-message': msg.sender.id !== Auth.userId}"
  class="message-item">
  <strong>{{ msg.sender.firstname }}:</strong> {{ msg.content }}
  </div>
  <div class="chat-input">
  <input [(ngModel)]="messageContent"  type="text" class="message-input" placeholder="Type your message here">
  <button (click)="sendMessage(selectedUserToSendMessage)" class="send-button">Send</button>
  </div>
  </div>





    <!-- in case there is no user -->
    </div>
    <div *ngIf="UsersList.length === 0" class="card border-0 shadow-sm mt-4 text-center py-5 bg-light">
  <div class="card-body">
    <i class="bi bi-person-x fs-1 text-danger mb-3"></i>
    <h5 class="card-title text-secondary">No User Found</h5>
    <p class="card-text text-muted">There are no users associated with this department at the moment.</p>
  </div>
</div>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-4">
    <pagination-controls
      id="users-pagination"
      class="myPagination"
      (pageChange)="p = $event"
    ></pagination-controls>
  </div>
</div>

  <!-- Add User Popup -->
<div *ngIf="AddUserPopup" class="modal show d-block" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title text-center fw w-100 fs-2" style="color: rgb(0, 0, 0);">ğŸ™â€â™‚ï¸ Add a new Employee</h3>
        <button type="button" class="btn-close" (click)="closeAddUserPopup()"></button>
      </div>
      <div class="modal-body">

        <div *ngIf="!isUsernameUnique(User.username) && User.username">
  <small class="text-danger">Ce Username existe dÃ©jÃ .</small>
</div>
        <input [(ngModel)]="User.firstname" placeholder="Name" class="form-control mb-2">
        <input [(ngModel)]="User.lastname" placeholder="Lastname" class="form-control mb-2">
        <input [(ngModel)]="User.username" placeholder="Username" class="form-control mb-2">
        <input [(ngModel)]="User.email" placeholder="Email" class="form-control mb-2">
        <input type="password" [(ngModel)]="User.password" placeholder="Password" class="form-control mb-2">

        <label class="form-label">Select Role</label>

        <select [(ngModel)]="User.role" class="form-select mb-2">
          <option value="EMPLOYEE">EMPLOYEE</option>
        </select>

        <label class="form-label">Select Department</label>
        <select class="form-select" [(ngModel)]="selecteddepartmentid" name="department" required>
        <option *ngFor="let dept of ListDeparments" [ngValue]="dept.id">{{ dept.departmentName }}</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" (click)="AddUser(User,selecteddepartmentid)">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Update User Popup -->
<div *ngIf="UpdateUserPopup" class="modal show d-block" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update User</h5>
        <button type="button" class="btn-close" (click)="closeUpdateUserPopup()"></button>
      </div>
      <div class="modal-body">

        <input [(ngModel)]="User.firstname" placeholder="Name" class="form-control mb-2">
        <input [(ngModel)]="User.lastname" placeholder="Lastname" class="form-control mb-2">
        <input [(ngModel)]="User.username" placeholder="Username" class="form-control mb-2">
        <input [(ngModel)]="User.password" placeholder="Password" class="form-control mb-2">
        <input [(ngModel)]="User.email" placeholder="Email" class="form-control mb-2">
        <select [(ngModel)]="User.role" class="form-select mb-2">
          <option value="" disabled selected>Select Role</option>
          <option value="MANAGER">MANAGER</option>
          <option value="EMPLOYEE">EMPLOYEE</option>
        </select>



<select class="form-select" [(ngModel)]="User.department" name="department" required disabled
        [compareWith]="compareDepartments">
  <option *ngFor="let dept of ListDeparments" [ngValue]="dept">{{ dept.departmentName }}</option>
</select>



      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" (click)="UpdateUser(User)">Update</button>
        <button class="btn btn-secondary" (click)="closeUpdateUserPopup()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- open Check Up Tasks by UserId -->
<div
  class="modal fade show d-block"
  *ngIf="CheckTasksByUserIdPopUp"
  tabindex="-1"
  style="background-color: rgba(0, 0, 0, 0.5);"
>
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4 border-0">
        <div class="modal-header bg-primary text-white rounded-top-4">
          <h5 class="modal-title w-100 text-center">
            ğŸ“User tasks
          </h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeCheckTasksByUserIdPopUp()"
        ></button>
      </div>

      <div class="modal-body">
        <div *ngIf="TasksList.length === 0" class="text-center text-muted">
          <p>User doesn't have any tasks.</p>
        </div>

        <div *ngIf="TasksList.length > 0" class="list-group">
          <div
            *ngFor="let task of TasksList | paginate: {id:'tasks-pagination', itemsPerPage: 2, currentPage: x } "
            class="list-group-item list-group-item-action flex-column align-items-start mb-2 rounded shadow-sm border-0"
          >
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1 text-primary">{{ task.taskTitle }}</h5>
              <small class="badge bg-info text-dark">
                {{ task.taskState }}
              </small>
            </div>
            <p class="mb-1 text-secondary">{{ task.taskDescription }}</p>
            <p class="mb-1 text-secondary">Related OKR: {{ task.okr?.keyindicatorTitle }}</p>
            <div class="d-flex justify-content-between mt-2">
              <small>ğŸ“ˆ Start: {{ task.taskStartValue }}</small>
              <small>âœ… Done: {{ task.taskDoneValue }}</small>
              <small>âš–ï¸ Weight: {{ task.taskWeight }}</small>
            </div>
          </div>
          <div class="d-flex justify-content-center mt-4">
    <pagination-controls
    id="tasks-pagination"
      class="myPagination"
      (pageChange)="x = $event"
    ></pagination-controls>
  </div>
        </div>
      </div>

      <div class="modal-footer justify-content-end">
        <button
        *ngIf="Auth.isManager()"
          type="button"
          class="btn btn-outline-secondary"
          (click)="closeCheckTasksByUserIdPopUp()"
        >
          âŒ
        </button>
        <button
        *ngIf="Auth.isManager()"
          type="button"
          class="btn btn-outline-primary"
          (click)="openAssignTaskPopup(this.selecteddepartmentIdInTaskPopUp, this.selectedUserIdInTaskPopUp)"
        >ğŸ§‘â€ğŸ’»
        </button>

      </div>
    </div>
  </div>
</div>

<!--open Assign Task to User-->
<div
  class="modal fade show d-block"
  *ngIf="AssignTaskPopup"
  tabindex="-1"
  style="background-color: rgba(0, 0, 0, 0.5);"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4 border-0">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title w-100 text-center">
          ğŸ“ Assign Task
        </h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="closeAssignTaskPopup()"
        ></button>
      </div>

      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="taskTitle" class="form-label"> Title</label>
            <input
              type="text"
              id="taskTitle"
              [(ngModel)]="Task.taskTitle"
              name="taskTitle"
              class="form-control"
              required
            />
          </div>
          <div class="mb-3">
            <label for="taskDescription" class="form-label"> Description</label>
            <textarea
              id="taskDescription"
              [(ngModel)]="Task.taskDescription"
              name="taskDescription"
              class="form-control"
              rows="3"
              required
            ></textarea>
            <label for="taskState" class="form-label">State</label>
            <select
              id="taskState"
              [(ngModel)]="Task.taskState"
              name="taskState"
              class="form-select mt-2"
              required
            >
              <option value="UNREACHED">UNREACHED</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="taskStartValue" class="form-label"> Start Value</label>
            <input
              type="number"
              id="taskStartValue"
              [(ngModel)]="Task.taskStartValue"
              name="taskStartValue"
              class="form-control"
              required
            />
            <label for="taskDoneValue" class="form-label"> Done Value</label>
            <input
              type="number"
              id="taskDoneValue"
              [(ngModel)]="Task.taskDoneValue"
              name="taskDoneValue"
              class="form-control mt-2"
              required
            />
            <label for="taskWeight" class="form-label">Task Weight</label>
            <input
              type="number"
              id="taskWeight"
              [(ngModel)]="Task.taskWeight"
              name="taskWeight"
              class="form-control mt-2"
              required
            />
            <label for="taskWeight" class="form-label">Select related OKR</label>
            <select
              class="form-select mt-2"
              [(ngModel)]="Task.okr"
              name="okr"
              required
            >
              <option *ngFor="let okr of OkrsList" [ngValue]="okr">{{ okr.keyindicatorTitle }}</option>
            </select>
            <div class="text-end mt-3">
            <button
              type="button"
              class="btn btn-primary"
              (click)="assignTaskToUser(Task, Task.okr.id, selectedUserIdInTaskPopUp)"
            >
              ğŸ“Œâœï¸
            </button>
            </div>
          </div>





