<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="row">
  <div class="col-xl-4 col-md-6">
    <div class="card earning-card bg-secondary-dark text-white overflow-hidden">
      <span class="round secondary-round small"></span>
      <span class="round secondary-round big"></span>
      <<!-- Citation avec effet de transition -->
<div class="card earning-card bg-secondary-dark text-white overflow-hidden">
  <span class="round secondary-round small"></span>
  <span class="round secondary-round big"></span>

  <div class="card-body">
    <div id="quote-container" class="fade text-white my-2">
      <span id="quote-text" class="d-block f-34 f-w-500">
        "A goal well set is half achieved."
        <i class="bi bi-arrow-up-right-circle opacity-50"></i>
      </span>
      <p id="quote-author" class="d-block f-34 f-w-100">
        Abraham Lincoln
      </p>
    </div>
  </div>
</div>

    </div>
  </div>
  <div class="col-xl-4 col-md-6">
  <div class="card text-white shadow-lg border-0 position-relative overflow-hidden" style="background: linear-gradient(135deg, #4e54c8, #8f94fb); border-radius: 20px;">
    <!-- Decorative Circle -->
    <div  class="card-body text-center position-relative z-1" *ngIf="topUser && topUser.firstname && topUser.lastname ; else noTopUser">
  <div class="mb-3">
    <i class="bi bi-trophy-fill text-warning" style="font-size: 2.5rem;"></i>
  </div>
  <h5 class="card-title fw-bold">{{ topUser.firstname }} {{ topUser.lastname }}</h5>
  <p class="mb-1">is achieving the most assigned tasks  <strong class="text-warning"></strong> üèÅ</p>
  <p class="small text-white-50">from the department {{ topUser.department.departmentName }}</p>
  <div class="mt-3">
    <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">
      ü•á Top Performer
    </span>
  </div>
</div>
<ng-template  #noTopUser>
  <div class="card-body text-center position-relative z-1">
    <p class="text-white-50 fst-italic">No top user found yet.ü•á</p>
  </div>
</ng-template>

  </div>
</div>

  <div class="col-xl-4 col-md-12">

    <div class="card total-income-card overflow-hidden bg-primary-dark text-white">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg icon m-r-5">
            <i class="text-white ti ti-layout-board-split f-24"></i>
          </div>
          <div class="ms-2">
            <h4 class="text-white f-w-600 mb-1">Welcome Back üëã </h4>
            <p class="mb-0 opacity-50 text-sm">{{auth.firstname}} {{auth.lastname}}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card total-income-card warning overflow-hidden">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg icon-warning m-r-5">
            <i class="text-warning ti ti-layout-board-split f-24"></i>
          </div>
          <div class="ms-2">
            <h4 class="f-w-600 mb-1">Contact Us Via : </h4>
            <p class="mb-0 opacity-100 text-sm">https://www.sqits.net</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<div *ngIf="Auth.isAdmin()" class="row mt-4">
  <!-- Colonne gauche : Stats -->
  <div class="col-lg-6 mb-4">
    <div class="row">
      <div class="col-md-12" *ngFor="let status of taskStats | keyvalue">
        <div class="card text-white shadow mb-3" [ngClass]="{
            'bg-danger': status.key === 'UNREACHED',
            'bg-primary': status.key === 'REACHED',
            'bg-warning': status.key === 'INPROGRESS',
          }">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title">{{ status.key.replace('_', ' ') }}</h5>
              <p class="card-text">{{ status.value }} task(s)</p>
            </div>
            <i class="bi bi-clipboard-check" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Colonne droite : Pie chart -->
  <div class="col-lg-6 mb-4">
  <div class="card pie-card" style="height: 100%;">
    <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
      <h5 class="mb-3 text-white d-flex align-items-center">
        <i class="bi bi-pie-chart-fill me-2 text-info"></i>
        Distribution of Objectives
      </h5>

      <!-- Affichage si on a des donn√©es -->
      <ng-container *ngIf="hasData; else noData">
        <apx-chart
          [series]="chartOptions.series"
          [chart]="chartOptions.chart"
          [labels]="chartOptions.labels"
          [responsive]="chartOptions.responsive"
        ></apx-chart>
      </ng-container>

      <!-- Affichage si vide -->
      <ng-template #noData>
        <div class="empty-state p-4 rounded-4 text-white shadow-sm">
          <i class="bi bi-stars display-4 text-warning mb-3"></i>
          <h6 class="fw-bold">No Objective Found</h6>
          <p class="text-muted mb-0" style="font-size: 0.9rem;">
            Add new objectives to see the distribution here.
          </p>
        </div>
      </ng-template>
    </div>
  </div>
</div>


</div>

<div class="container mt-5" *ngIf="Auth.isAdmin()">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">üéØ Check our Objectives</h2>
    <button type="button" class="btn btn-gradient btn-outline-info" (click)="openAddObjectivePopup()">
      <i class="bi bi-plus-circle me-2"></i>
    </button>
  </div>

  <div *ngIf="ObjectivesList.length === 0" class="alert alert-warning text-center fw-bold shadow-sm">
    <i class="bi bi-exclamation-circle me-2"></i> No Objective found.
  </div>

  <div class="row g-4">
    <div class="col-xl-6 col-md-12" *ngFor="let objective of ObjectivesList | paginate: { itemsPerPage: 4, currentPage: p }">
      <div class="card shadow border-0 h-100 rounded-4 p-3 bg-light position-relative">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="fw-bold text-primary mb-2">{{ objective.objectiveTitle }}</h5>
            <p class="text-muted small mb-2">{{ objective.objectiveDescription }}</p>
            <span class="badge rounded-pill text-white px-3 py-1"
              [ngClass]="{
                'bg-success': objective.objectiveStatus === 'REACHED',
                'bg-primary': objective.objectiveStatus === 'INPROGRESS',
                'bg-warning text-dark': objective.objectiveStatus === 'UNREACHED',
                'bg-secondary': !['REACHED', 'INPROGRESS', 'UNREACHED'].includes(objective.objectiveStatus)
              }">
              <i class="bi bi-flag-fill me-1"></i> {{ objective.objectiveStatus }}
            </span>
          </div>
          <div class="d-flex gap-2">
  <button
    class="btn btn-sm btn-outline-primary d-flex align-items-center"
    (click)="openUpdateObjectivePopup(objective)"
  >
    <i class="bi bi-pencil-square me-1"></i>
  </button>
  <button
    class="btn btn-sm btn-outline-danger d-flex align-items-center"
    (click)="DeleteObjective(objective)"
  >
    <i class="bi bi-trash3 me-1"></i>
  </button>
</div>

        </div>

        <div class="mt-3">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">Progress</small>
            <small class="fw-bold">{{ objective.objectiveProgress }}%</small>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar bg-success" role="progressbar"
              [style.width.%]="objective.objectiveProgress"
              [attr.aria-valuenow]="objective.objectiveProgress"
              aria-valuemin="0" aria-valuemax="100">
            </div>
          </div>
        </div>

        <div class="position-absolute bottom-0 end-0 p-2">
          <span class="badge bg-dark text-white px-3 py-1">
            <i class="bi bi-stars me-1"></i> Score: {{ objective.objectiveScore }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-center mt-4">
    <pagination-controls class="myPagination" (pageChange)="p = $event"></pagination-controls>
  </div>
</div>



  <!-- Form Update Objective Popu-up -->
<div class="popup_overlay" *ngIf="UpdateObjectivePopup">
  <form class="form_container">
    <div class="title_container">
      <p class="title">Keep your team updated with this update!</p>
    </div>

    <div class="input_container">
      <label class="input_label" for="title_field">Title</label>
      <input placeholder="Title" type="text" class="input_field" id="title_field" [(ngModel)]="Objective.objectiveTitle" name="title" />
    </div>

    <div class="input_container">
      <label class="input_label" for="description_field">Description</label>
      <input placeholder="Description" type="text" class="input_field" id="description_field" [(ngModel)]="Objective.objectiveDescription" name="description" />
    </div>

    <div class="input_container">
      <label class="input_label" for="status_field">Status</label>
      <select class="input_field" id="status_field" [(ngModel)]="Objective.objectiveStatus" name="status">
        <option value="UNREACHED">UnReached</option>
        <option value="INPROGRESS">In Progress</option>
        <option value="REACHED">Reached</option>
      </select>
    </div>

    <div class="input_container">
      <label class="input_label" for="score_field">Score</label>
      <input placeholder="Score" type="number" class="input_field" id="score_field" [(ngModel)]="Objective.objectiveScore" name="score" />
    </div>

    <div class="input_container">
      <label class="input_label" for="progress_field">Progress</label>
      <input placeholder="Progress" type="number" class="input_field" id="progress_field" [(ngModel)]="Objective.objectiveProgress" name="progress" />
    </div>

    <button type="submit" class="sign-in_btn" (click)="UpdateObjective(Objective)">Update</button>

    <button type="submit" class="sign-in_apl" (click)="closeUpdateObjectivePopup()">Close</button>

    <div class="separator">
      <hr class="line" />
      <hr class="line" />
    </div>

    <p class="note">Terms of use & Conditions</p>
  </form>
</div>
<!-- end of Update Objective popup-form -->


<!-- Form Add Objective Popu-up -->
<div class="popup_overlay" *ngIf="AddObjectivePopup">
  <form class="form_container">
    <div class="title_container">
      <p class="title">‚ûï Keep your team updated with a new objective!</p>
    </div>

    <div class="input_container">
      <label class="input_label" for="title_field">Title</label>
      <input placeholder="Title" type="text" class="input_field" id="title_field" [(ngModel)]="Objective.objectiveTitle" name="title" />
    </div>

    <div class="input_container">
      <label class="input_label" for="description_field">Description</label>
      <input placeholder="Description" type="text" class="input_field" id="description_field" [(ngModel)]="Objective.objectiveDescription" name="description" />
    </div>

    <div class="input_container">
      <label class="input_label" for="status_field">Status</label>
      <select class="input_field" id="status_field" [(ngModel)]="Objective.objectiveStatus" name="status">
        <option value="UNREACHED">UnReached</option>
      </select>
    </div>

    <div class="input_container">
      <label class="input_label" for="score_field">Score</label>
      <input placeholder="Score" type="number" class="input_field" id="score_field" [(ngModel)]="Objective.objectiveScore" name="score" />
    </div>

    <div class="input_container">
      <label class="input_label" for="progress_field">Progress</label>
      <input placeholder="Progress" type="number" class="input_field" id="progress_field" [(ngModel)]="Objective.objectiveProgress" name="progress" />
    </div>

    <button type="submit" class="sign-in_btn" (click)="AddObjective(Objective)">Add</button>

    <button type="submit" class="sign-in_apl" (click)="closeAddObjectivePopup()">Close</button>

    <div class="separator">
      <hr class="line" />
      <hr class="line" />
    </div>

    <p class="note">Terms of use & Conditions</p>
  </form>
</div>
<!-- end of Add Objective popup-form -->

<div  class="col-xl-6 col-md-12 mt-4" *ngIf="tasksByDepartment.length > 0 && Auth.isManager()">
  <div class="card shadow-lg border-0 rounded-4 overflow-hidden"
      style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white;">

    <div *ngIf="Auth.isManager()" class="card-body">
      <h5 class="fw-bold text-white mb-4 d-flex align-items-center">
        <i class="bi bi-check2-square me-2 fs-4"></i> Tasks from Department
      </h5>

      <div *ngFor="let task of tasksByDepartment" class="mb-3 p-3 rounded-3 bg-white text-dark shadow-sm border-start border-4"
          [ngClass]="{
            'border-danger': task.taskState === 'UNREACHED',
            'border-primary': task.taskState === 'REACHED',
            'border-warning': task.taskState === 'INPROGRESS'
          }">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1 fw-bold">{{ task.taskTitle }}</h6>
            <p class="mb-0 text-muted small">{{ task.taskDescription }}</p>
          </div>
          <span class="badge px-3 py-2 rounded-pill fs-6"
                [ngClass]="{
                  'bg-danger': task.taskState === 'UNREACHED',
                  'bg-primary': task.taskState === 'REACHED',
                  'bg-warning text-dark': task.taskState === 'INPROGRESS'
                }">
            <i class="bi bi-flag-fill me-1"></i> {{ task.taskState }}
          </span>
        </div>

        <div class="mt-2 small text-muted d-flex align-items-center">
          <i class="bi bi-graph-up-arrow me-2 text-primary"></i>
          Weight: {{ task.taskWeight }} |
          Start: {{ task.taskStartValue }} ‚Üí Done: {{ task.taskDoneValue }} |
          Assigned to: {{ task.user.firstname }} {{ task.user.lastname }}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Message si aucune t√¢che -->
<div *ngIf="tasksByDepartment.length === 0 && Auth.isManager()" class="card border-0 shadow-sm mt-4 text-center py-5 bg-light">
  <div class="card-body">
    <i class="bi bi-building-x fs-1 text-danger mb-3"></i>
    <h5 class="card-title text-secondary">No Tasks Found</h5>
    <p class="card-text text-muted">There are no tasks associated with this department at the moment.</p>
  </div>
</div>


<div>
<div *ngIf="Auth.isEmployee()" class="task-stats-container">
  <div class="task-card reached">
    <div class="icon">‚úÖ</div>
    <div class="label">Reached</div>
    <div class="count">{{ TaskStatsByUser['REACHED'] || 0 }}</div>
  </div>

  <div class="task-card inprogress">
    <div class="icon">üîÑ</div>
    <div class="label">In Progress</div>
    <div class="count">{{ TaskStatsByUser['INPROGRESS'] || 0 }}</div>
  </div>

  <div class="task-card unreached">
    <div class="icon">‚ùå</div>
    <div class="label">Unreached</div>
    <div class="count">{{ TaskStatsByUser['UNREACHED'] || 0 }}</div>
  </div>
</div>


</div>

